function raiseHam_PBC(Jmaxpos,iteration,chi_incs)
%raiseHam_PBC(Jmaxpos,iteration,chi_incs)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% dMERA - raiseHam_PBC
% raises Hamiltonian up by one level
% 
% Andrew Goldsborough - 24/11/2016
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

global w u h VMDH;

%contraction orders from netcon
h_1_order = {[-3,5,3,4],[3,1],[-1,-2,5,6],[-4,6,2,4],[2,1]};
h_2_order = {[-1,13,12,14],[12,1],[1,10,-3,11],[14,8,10,9],[13,6,8,7],[4,7,5,9],[-2,6,3,4],[3,2],[2,5,-4,11]};
h_3_order = {[-1,13,12,14],[12,1],[1,8,-3,9],[14,5,8,6],[5,3,6,4],[10,3,7,4],[-2,13,11,10],[11,2],[2,7,-4,9]};
h_4_order = {[-1,13,12,14],[12,1],[1,8,-3,9],[14,6,8,7],[7,4,9,5],[10,6,3,4],[-2,13,11,10],[11,2],[2,3,-4,5]};
h_5_order = {[1,3],[3,4,-1,5],[5,6,-3,-4],[2,4,-2,6],[1,2]};
h_1_inc_order = {[-3,2,1],[-1,-2,2,3],[-4,3,1]};
h_2_inc_order = {[-1,7,8],[-3,9,1],[8,5,9,6],[7,3,5,4],[2,4,10,6],[-2,3,2],[-4,10,1]};
h_3_inc_order = {[-1,1,9],[-3,7,2],[9,5,7,6],[5,3,6,4],[10,3,8,4],[-2,1,10],[-4,8,2]};
h_4_inc_order = {[-1,1,9],[-3,7,8],[9,5,7,6],[6,3,8,4],[10,5,2,3],[-2,1,10],[-4,2,4]};
h_5_inc_order = {[-1,1,2],[2,3,-3,-4],[-2,1,3]};

%store current chain length
Lcur = size(h,1);

if chi_incs == 0
    %normal structure
    
    %leftmost: Jmaxpos-2
    h{PBC_pos(Jmaxpos-2,Lcur)} = ncon({w{iteration,1},VMDH,h{PBC_pos(Jmaxpos-2,Lcur)},conj(w{iteration,1}),conj(VMDH)},h_1_order);
        
    %left: Jmaxpos-1
    h{PBC_pos(Jmaxpos-1,Lcur)} = ncon({w{iteration,1},VMDH,w{iteration,2},u{iteration,1},h{PBC_pos(Jmaxpos-1,Lcur)},...
        conj(u{iteration,1}),conj(w{iteration,1}),conj(VMDH),conj(w{iteration,2})},h_2_order);
    
    %centre: Jmaxpos
    h{Jmaxpos} = ncon({w{iteration,1},VMDH,w{iteration,2},u{iteration,1},h{Jmaxpos},...
        conj(u{iteration,1}),conj(w{iteration,1}),conj(VMDH),conj(w{iteration,2})},h_3_order);
    
    %right: Jmaxpos+1
    h{PBC_pos(Jmaxpos+1,Lcur)} = ncon({w{iteration,1},VMDH,w{iteration,2},u{iteration,1},h{PBC_pos(Jmaxpos+1,Lcur)},...
        conj(u{iteration,1}),conj(w{iteration,1}),conj(VMDH),conj(w{iteration,2})},h_4_order);
        
    %rightmost: Jmaxpos+2
    h{PBC_pos(Jmaxpos+2,Lcur)} = ncon({VMDH,w{iteration,2},h{PBC_pos(Jmaxpos+2,Lcur)},conj(w{iteration,2}),conj(VMDH)},h_5_order);
    
    %coarse grain by 2 sites
    h{PBC_pos(Jmaxpos-1,Lcur)} = h{PBC_pos(Jmaxpos-1,Lcur)} + h{Jmaxpos} + h{PBC_pos(Jmaxpos+1,Lcur)};
    h(Jmaxpos) = [];
    h(PBC_pos(Jmaxpos,Lcur-1)) = [];
    
elseif chi_incs == 1
    %chi increases
    
    %leftmost: Jmaxpos-2
    h{PBC_pos(Jmaxpos-2,Lcur)} = ncon({w{iteration,1},h{PBC_pos(Jmaxpos-2,Lcur)},conj(w{iteration,1})},h_1_inc_order);
    
    %left: Jmaxpos-1
    h{PBC_pos(Jmaxpos-1,Lcur)} = ncon({w{iteration,1},w{iteration,2},u{iteration,1},h{PBC_pos(Jmaxpos-1,Lcur)},conj(u{iteration,1}),...
        conj(w{iteration,1}),conj(w{iteration,2})},h_2_inc_order);
    
    %centre: Jmaxpos
    h{Jmaxpos} = ncon({w{iteration,1},w{iteration,2},u{iteration,1},h{Jmaxpos},conj(u{iteration,1}),...
        conj(w{iteration,1}),conj(w{iteration,2})},h_3_inc_order);
    
    %right: Jmaxpos+1
    h{PBC_pos(Jmaxpos+1,Lcur)} = ncon({w{iteration,1},w{iteration,2},u{iteration,1},h{PBC_pos(Jmaxpos+1,Lcur)},conj(u{iteration,1}),...
        conj(w{iteration,1}),conj(w{iteration,2})},h_4_inc_order);
    
    %rightmost: Jmaxpos+2
    h{PBC_pos(Jmaxpos+2,Lcur)} = ncon({w{iteration,2},h{PBC_pos(Jmaxpos+2,Lcur)},conj(w{iteration,2})},h_5_inc_order);
    
    %coarse grain by 2 sites
    h{PBC_pos(Jmaxpos-1,Lcur)} = h{PBC_pos(Jmaxpos-1,Lcur)} + h{Jmaxpos} + h{PBC_pos(Jmaxpos+1,Lcur)};
    h(Jmaxpos) = [];
    h(PBC_pos(Jmaxpos,Lcur-1)) = [];
end

%force hermiticity
h{PBC_pos(Jmaxpos-2,Lcur-2)} = 0.5*(h{PBC_pos(Jmaxpos-2,Lcur-2)} + conj(permute(h{PBC_pos(Jmaxpos-2,Lcur-2)},[2,1,4,3])));
h{PBC_pos(Jmaxpos-1,Lcur-2)} = 0.5*(h{PBC_pos(Jmaxpos-1,Lcur-2)} + conj(permute(h{PBC_pos(Jmaxpos-1,Lcur-2)},[2,1,4,3])));
h{PBC_pos(Jmaxpos,Lcur-2)} = 0.5*(h{PBC_pos(Jmaxpos,Lcur-2)} + conj(permute(h{PBC_pos(Jmaxpos,Lcur-2)},[2,1,4,3])));
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%find optimal contraction orders
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% h_1_netcon(netcon({[-3,3,1,4],[1,2],[-1,-2,3,5],[-4,5,6,4],[6,2]},0,2,1,1)) = 1:6;
% h_1_order = {[-3,h_1_netcon(3),h_1_netcon(1),h_1_netcon(4)],...
%     [h_1_netcon(1),h_1_netcon(2)],...
%     [-1,-2,h_1_netcon(3),h_1_netcon(5)],...
%     [-4,h_1_netcon(5),h_1_netcon(6),h_1_netcon(4)],...
%     [h_1_netcon(6),h_1_netcon(2)]};
% 
% h_2_netcon(netcon({[-1,3,1,4],[1,2],[2,5,-3,6],[4,7,5,8],[3,9,7,10],[11,10,12,8],[-2,9,13,11],[13,14],[14,12,-4,6]},0,2,1,1)) = 1:14;
% h_2_order = {[-1,h_2_netcon(3),h_2_netcon(1),h_2_netcon(4)],...
%     [h_2_netcon(1),h_2_netcon(2)],...
%     [h_2_netcon(2),h_2_netcon(5),-3,h_2_netcon(6)],...
%     [h_2_netcon(4),h_2_netcon(7),h_2_netcon(5),h_2_netcon(8)],...
%     [h_2_netcon(3),h_2_netcon(9),h_2_netcon(7),h_2_netcon(10)],...
%     [h_2_netcon(11),h_2_netcon(10),h_2_netcon(12),h_2_netcon(8)],...
%     [-2,h_2_netcon(9),h_2_netcon(13),h_2_netcon(11)],...
%     [h_2_netcon(13),h_2_netcon(14)],...
%     [h_2_netcon(14),h_2_netcon(12),-4,h_2_netcon(6)]};
% 
% h_3_netcon(netcon({[-1,3,1,4],[1,2],[2,5,-3,6],[4,7,5,8],[7,9,8,10],[11,9,12,10],[-2,3,13,11],[13,14],[14,12,-4,6]},0,2,1,1)) = 1:14;
% h_3_order = {[-1,h_3_netcon(3),h_3_netcon(1),h_3_netcon(4)],...
%     [h_3_netcon(1),h_3_netcon(2)],...
%     [h_3_netcon(2),h_3_netcon(5),-3,h_3_netcon(6)],...
%     [h_3_netcon(4),h_3_netcon(7),h_3_netcon(5),h_3_netcon(8)],...
%     [h_3_netcon(7),h_3_netcon(9),h_3_netcon(8),h_3_netcon(10)],...
%     [h_3_netcon(11),h_3_netcon(9),h_3_netcon(12),h_3_netcon(10)],...
%     [-2,h_3_netcon(3),h_3_netcon(13),h_3_netcon(11)],...
%     [h_3_netcon(13),h_3_netcon(14)],...
%     [h_3_netcon(14),h_3_netcon(12),-4,h_3_netcon(6)]};
% 
% h_4_netcon(netcon({[-1,3,1,4],[1,2],[2,5,-3,6],[4,7,5,8],[8,9,6,10],[11,7,12,9],[-2,3,13,11],[13,14],[14,12,-4,10]},0,2,1,1)) = 1:14;
% h_4_order = {[-1,h_4_netcon(3),h_4_netcon(1),h_4_netcon(4)],...
%     [h_4_netcon(1),h_4_netcon(2)],...
%     [h_4_netcon(2),h_4_netcon(5),-3,h_4_netcon(6)],...
%     [h_4_netcon(4),h_4_netcon(7),h_4_netcon(5),h_4_netcon(8)],...
%     [h_4_netcon(8),h_4_netcon(9),h_4_netcon(6),h_4_netcon(10)],...
%     [h_4_netcon(11),h_4_netcon(7),h_4_netcon(12),h_4_netcon(9)],...
%     [-2,h_4_netcon(3),h_4_netcon(13),h_4_netcon(11)],...
%     [h_4_netcon(13),h_4_netcon(14)],...
%     [h_4_netcon(14),h_4_netcon(12),-4,h_4_netcon(10)]};
% 
% h_5_netcon(netcon({[1,2],[2,3,-1,4],[4,5,-3,-4],[6,3,-2,5],[1,6]},0,2,1,1)) = 1:6;
% h_5_order = {[h_5_netcon(1),h_5_netcon(2)],...
%     [h_5_netcon(2),h_5_netcon(3),-1,h_5_netcon(4)],...
%     [h_5_netcon(4),h_5_netcon(5),-3,-4],...
%     [h_5_netcon(6),h_5_netcon(3),-2,h_5_netcon(5)],...
%     [h_5_netcon(1),h_5_netcon(6)]};
% 
% h_1_inc_netcon(netcon({[-3,1,2],[-1,-2,1,3],[-4,3,2]},0,2,1,1)) = 1:3;
% h_1_inc_order = {[-3,h_1_inc_netcon(1),h_1_inc_netcon(2)],...
%     [-1,-2,h_1_inc_netcon(1),h_1_inc_netcon(3)],...
%     [-4,h_1_inc_netcon(3),h_1_inc_netcon(2)]};
% 
% h_2_inc_netcon(netcon({[-1,1,2],[-3,3,4],[2,5,3,6],[1,7,5,8],[9,8,10,6],[-2,7,9],[-4,10,4]},0,2,1,1)) = 1:10;
% h_2_inc_order = {[-1,h_2_inc_netcon(1),h_2_inc_netcon(2)],...
%     [-3,h_2_inc_netcon(3),h_2_inc_netcon(4)],...
%     [h_2_inc_netcon(2),h_2_inc_netcon(5),h_2_inc_netcon(3),h_2_inc_netcon(6)],...
%     [h_2_inc_netcon(1),h_2_inc_netcon(7),h_2_inc_netcon(5),h_2_inc_netcon(8)],...
%     [h_2_inc_netcon(9),h_2_inc_netcon(8),h_2_inc_netcon(10),h_2_inc_netcon(6)],...
%     [-2,h_2_inc_netcon(7),h_2_inc_netcon(9)],...
%     [-4,h_2_inc_netcon(10),h_2_inc_netcon(4)]};
% 
% h_3_inc_netcon(netcon({[-1,1,2],[-3,3,4],[2,5,3,6],[5,7,6,8],[9,7,10,8],[-2,1,9],[-4,10,4]},0,2,1,1)) = 1:10;
% h_3_inc_order = {[-1,h_3_inc_netcon(1),h_3_inc_netcon(2)],...
%     [-3,h_3_inc_netcon(3),h_3_inc_netcon(4)],...
%     [h_3_inc_netcon(2),h_3_inc_netcon(5),h_3_inc_netcon(3),h_3_inc_netcon(6)],...
%     [h_3_inc_netcon(5),h_3_inc_netcon(7),h_3_inc_netcon(6),h_3_inc_netcon(8)],...
%     [h_3_inc_netcon(9),h_3_inc_netcon(7),h_3_inc_netcon(10),h_3_inc_netcon(8)],...
%     [-2,h_3_inc_netcon(1),h_3_inc_netcon(9)],[-4,h_3_inc_netcon(10),h_3_inc_netcon(4)]}
% 
% h_4_inc_netcon(netcon({[-1,1,2],[-3,3,4],[2,5,3,6],[6,7,4,8],[9,5,10,7],[-2,1,9],[-4,10,8]},0,2,1,1)) = 1:10;
% h_4_inc_order = {[-1,h_4_inc_netcon(1),h_4_inc_netcon(2)],...
%     [-3,h_4_inc_netcon(3),h_4_inc_netcon(4)],...
%     [h_4_inc_netcon(2),h_4_inc_netcon(5),h_4_inc_netcon(3),h_4_inc_netcon(6)],...
%     [h_4_inc_netcon(6),h_4_inc_netcon(7),h_4_inc_netcon(4),h_4_inc_netcon(8)],...
%     [h_4_inc_netcon(9),h_4_inc_netcon(5),h_4_inc_netcon(10),h_4_inc_netcon(7)],...
%     [-2,h_4_inc_netcon(1),h_4_inc_netcon(9)],[-4,h_4_inc_netcon(10),h_4_inc_netcon(8)]};
% 
% h_5_inc_netcon(netcon({[-1,1,2],[2,3,-3,-4],[-2,1,3]},0,2,1,1)) = 1:3;
% h_5_inc_order = {[-1,h_5_inc_netcon(1),h_5_inc_netcon(2)],...
%     [h_5_inc_netcon(2),h_5_inc_netcon(3),-3,-4],...
%     [-2,h_5_inc_netcon(1),h_5_inc_netcon(3)]};